<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicios de Práctica</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
          --primary-color: #4ecdc4;
          --secondary-color: #667eea;
          --accent-color: #ff6b6b;
          --success-color: #2ecc71;
          --warning-color: #f39c12;
          --error-color: #e74c3c;
          --text-color: #2c3e50;
          --bg-light: #f8f9fa;
          --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, var(--secondary-color) 0%, #764ba2 100%);
          min-height: 100vh;
          color: var(--text-color);
          line-height: 1.6;
          padding: 20px;
      }
      .app-container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          min-height: 90vh;
          box-shadow: var(--shadow-hover);
          border-radius: 20px;
          overflow: hidden;
          position: relative;
      }
      .header {
          background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
          color: white;
          text-align: center;
          padding: 2rem;
          position: sticky;
          top: 0;
          z-index: 100;
          box-shadow: var(--shadow);
      }
      .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 700; }
      .header p { font-size: 1.1rem; opacity: 0.9; }
      .main-content { display: flex; min-height: calc(100vh - 200px); }
      .sidebar {
          width: 280px;
          background: var(--bg-light);
          padding: 2rem 1.5rem;
          border-right: 1px solid #dee2e6;
      }
      .sidebar h3 {
          color: var(--text-color);
          margin-bottom: 1rem;
          font-size: 1.1rem;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      .nav-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem 1rem;
          margin-bottom: 0.5rem;
          border-radius: 8px;
          text-decoration: none;
          color: #666;
          border: 2px solid transparent;
          position: relative;
          background: white;
          cursor: pointer;
      }
      .nav-item.active {
          background: var(--primary-color);
          color: white;
          border-color: var(--secondary-color);
          font-weight: bold;
      }
      .nav-item:hover:not(.active) {
          background: #f0faff;
          color: var(--primary-color);
          transform: translateX(3px);
          transition: all 0.2s ease;
      }
      .content-area {
          flex: 1;
          padding: 2rem;
      }
      .card {
          background: white;
          border-radius: 12px;
          padding: 2rem;
          margin-bottom: 1.5rem;
          box-shadow: var(--shadow);
          border: 1px solid #e9ecef;
      }
      .card.highlight {
          border-left: 5px solid var(--primary-color);
      }
      .exercise {
          background: #fdfdff;
          border-radius: 10px;
          padding: 1.5rem;
          margin-bottom: 1.5rem;
          border: 1px solid #e9ecef;
          box-shadow: var(--shadow);
          transition: all 0.3s ease;
      }
      .exercise:hover {
          box-shadow: var(--shadow-hover);
          transform: translateY(-2px);
      }
      .exercise-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid #eee;
      }
      .exercise-title { font-weight: 600; font-size: 1.2rem; color: var(--text-color); }
      .difficulty-badge {
          padding: 0.25rem 0.75rem;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 500;
          color: white;
      }
      .difficulty-Fácil { background: var(--success-color); }
      .difficulty-Medio { background: var(--warning-color); }
      .difficulty-Difícil { background: var(--error-color); }
      .input-group { margin: 1.5rem 0; display: flex; align-items: center; gap: 1rem; }
      .math-input {
          padding: 0.75rem;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 1.1rem;
          transition: all 0.3s ease;
      }
      .math-input:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
      }
      .feedback { margin-top: 1rem; padding: 1rem; border-radius: 8px; font-weight: 500; display: none; }
      .feedback.correct { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; border: 1px solid #c3e6cb; }
      .feedback.incorrect { background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; border: 1px solid #f5c6cb; }
      .feedback.show { display: block; animation: fadeIn 0.3s ease; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .page-nav-buttons {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
      }
      .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
      .modal-content { background-color: #fff; margin: 20px; border-radius: 10px; width: 80%; max-width: 1200px; height: 80%; display: flex; flex-direction: column; overflow: hidden; }
      .modal-header { display: flex; justify-content: flex-end; padding: 10px; background: #f1f1f1; border-bottom: 1px solid #ddd; }
      .modal-header span { font-size: 1.5rem; cursor: pointer; }
      .modal-body { flex: 1; padding: 0; }
      .modal-body iframe { width: 100%; height: 100%; border: none; }
      #open-modal { cursor: pointer; }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="header">
        <h1><i class="fas fa-pencil-alt"></i> Ejercicios de Práctica</h1>
        <p>Pon a prueba tus conocimientos</p>
      </div>
      <div class="main-content" id="main-content-container">
        <!-- Content will be dynamically generated here -->
      </div>
    </div>

    <div class="page-nav-buttons">
      <button class="btn btn-secondary" onclick="history.back()"><i class="fas fa-arrow-left"></i> Volver</button>
      <button class="btn" id="back-to-top-btn" style="display: none;"><i class="fas fa-arrow-up"></i> Volver Arriba</button>
    </div>

    <div class="floating-notification" id="open-modal">
      <i class="fa-solid fa-hands-holding-child" style="color: #317bb4"></i>
      <span>Ayuda académica</span>
    </div>

    <div id="modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span id="close-modal">&times;</span></div>
        <div class="modal-body"><iframe src="https://tutor-ia-escolar.web.app/"></iframe></div>
      </div>
    </div>

    <script src="content.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const module = params.get("module");
        if (!module) {
          displayError("Módulo no especificado.");
          return;
        }
        const { grade, subjectName } = parseModuleId(module);
        if (!grade || !subjectName) {
          displayError("ID de módulo inválido.");
          return;
        }
        updateHeaders(grade, subjectName);
        renderExercises(module);
        setupHelpModal();
        setupNavButtons();
      });

      function setupNavButtons() {
        const backToTopButton = document.getElementById("back-to-top-btn");
        if(backToTopButton) {
            window.onscroll = () => {
                if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                    backToTopButton.style.display = "block";
                } else {
                    backToTopButton.style.display = "none";
                }
            };
            backToTopButton.addEventListener("click", () => window.scrollTo({top: 0, behavior: 'smooth'}));
        }
      }

      function setupHelpModal() {
        const helpModal = document.getElementById("modal");
        const openHelpModal = document.getElementById("open-modal");
        const closeHelpModal = document.getElementById("close-modal");
        if(helpModal && openHelpModal && closeHelpModal) {
            openHelpModal.onclick = () => { helpModal.style.display = "flex"; };
            closeHelpModal.onclick = () => { helpModal.style.display = "none"; };
            window.onclick = (e) => { if (e.target === helpModal) { helpModal.style.display = "none"; } };
        }
      }

      function parseModuleId(module) {
        if (!module || !module.startsWith('g') || module.indexOf('-') === -1) return {};
        const firstDashIndex = module.indexOf('-');
        const gradeNum = module.substring(1, firstDashIndex);
        const subjectId = module.substring(firstDashIndex + 1);
        if (isNaN(parseInt(gradeNum))) return {};
        const grade = `${gradeNum}mo Grado`;
        const subjectName = subjectId.charAt(0).toUpperCase() + subjectId.slice(1).replace(/-/g, " ");
        return { grade, subjectId, subjectName };
      }

      function updateHeaders(grade, subjectName) {
        const headerTitle = document.querySelector(".header h1");
        const pageTitle = document.querySelector("title");
        const breadcrumb = document.querySelector(".header p");
        const fullTitle = `Ejercicios de ${subjectName}`;
        if (headerTitle) headerTitle.innerHTML = `<i class="fas fa-pen-to-square"></i> ${fullTitle}`;
        if (pageTitle) pageTitle.textContent = fullTitle;
        if (breadcrumb) breadcrumb.textContent = `Módulo de práctica para ${grade}`;
      }

      function displayError(message) {
        const contentArea = document.getElementById("main-content-container");
        if (contentArea) contentArea.innerHTML = `<div class="card" style="text-align: center;"><h2><i class="fas fa-exclamation-triangle"></i> Error</h2><p>${message}</p><a href="index.html" class="btn">Volver</a></div>`;
      }

      function renderExercises(module) {
        const contentArea = document.getElementById("main-content-container");
        if (typeof contentData === 'undefined' || !contentData[module]) {
          return displayError("Contenido para este módulo no encontrado.");
        }
        const data = contentData[module];
        contentArea.innerHTML = `
            <nav class="sidebar" aria-label="Navegación de unidades">
                <h3><i class="fas fa-book" aria-hidden="true"></i> Unidades</h3>
                <div id="sidebar-nav-items"></div>
            </nav>
            <main class="content-area" role="main" id="exercise-main-content"></main>
        `;
        const sidebarNav = document.getElementById('sidebar-nav-items');
        let firstUnitId = '';
        data.units.forEach((unit, index) => {
            const unitId = `unit-${index}`;
            if(index === 0) firstUnitId = unitId;
            const navItem = document.createElement('div');
            navItem.className = 'nav-item';
            navItem.dataset.unitId = unitId;
            navItem.innerHTML = `<span>${unit.title}</span>`;
            navItem.onclick = () => showUnit(unitId, data);
            sidebarNav.appendChild(navItem);
        });
        if(firstUnitId) {
            showUnit(firstUnitId, data);
            sidebarNav.querySelector('.nav-item').classList.add('active');
        }
      }

      function showUnit(unitId, data) {
        const unitIndex = parseInt(unitId.split('-')[1]);
        const unit = data.units[unitIndex];
        const exerciseContent = document.getElementById('exercise-main-content');
        document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.sidebar .nav-item[data-unit-id="${unitId}"]`).classList.add('active');
        let exercisesHtml = `<h2><i class="fas fa-tasks"></i> ${unit.title}</h2>`;
        let hasExercises = false;
        unit.lessons.forEach((lesson, lessonIndex) => {
            if(lesson.examples && lesson.examples.length > 0) {
                hasExercises = true;
                exercisesHtml += `<div class="card highlight"><h3>${lesson.title}</h3></div>`;
                lesson.examples.forEach((ex, exIndex) => {
                    const exerciseId = `ex-${unitIndex}-${lessonIndex}-${exIndex}`;
                    const difficultyClass = ex.difficulty ? `difficulty-${ex.difficulty.replace(' ', '')}` : '';
                    exercisesHtml += `
                        <div class="exercise">
                            <div class="exercise-header">
                                <span class="exercise-title">${ex.problem}</span>
                                ${ex.difficulty ? `<span class="difficulty-badge ${difficultyClass}">${ex.difficulty}</span>` : ''}
                            </div>
                            <div class="input-group">
                                <input type="text" class="math-input" id="answer-${exerciseId}" placeholder="Tu respuesta">
                                <button class="btn" onclick="checkAnswer('${exerciseId}', '${ex.solution}')">Verificar</button>
                            </div>
                            <div class="feedback" id="feedback-${exerciseId}"></div>
                        </div>`;
                });
            }
        });
        if(!hasExercises) exercisesHtml += '<p>No hay ejercicios en esta unidad.</p>';
        exerciseContent.innerHTML = exercisesHtml;
      }

      function checkAnswer(exerciseId, correctAnswer) {
          const answerInput = document.getElementById(`answer-${exerciseId}`);
          const userAnswer = answerInput.value.trim();
          const feedbackEl = document.getElementById(`feedback-${exerciseId}`);
          const normalizedUserAnswer = userAnswer.replace(/\s/g, '').toLowerCase();
          const normalizedCorrectAnswer = String(correctAnswer).replace(/\s/g, '').toLowerCase();
          if (normalizedUserAnswer === normalizedCorrectAnswer) {
              feedbackEl.innerHTML = '<i class="fas fa-check-circle"></i> ¡Correcto!';
              feedbackEl.className = 'feedback correct show';
          } else {
              feedbackEl.innerHTML = `Incorrecto. La respuesta correcta es: <strong>${correctAnswer}</strong>`;
              feedbackEl.className = 'feedback incorrect show';
          }
      }
    </script>
  </body>
</html>
